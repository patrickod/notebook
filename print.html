<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Patrick's Lab Notebook</title>
        
        <meta name="robots" content="noindex" />
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="favicon.svg">
        
        
        <link rel="shortcut icon" href="favicon.png">
        
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        
        <link rel="stylesheet" href="css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="intro.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="projects/intro.html"><strong aria-hidden="true">2.</strong> Projects</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="projects/mcp2221a-rs.html"><strong aria-hidden="true">2.1.</strong> MCP2221-rs</a></li></ol></li><li class="chapter-item expanded "><a href="infrastructure/intro.html"><strong aria-hidden="true">3.</strong> Infrastructure</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="infrastructure/qemu.html"><strong aria-hidden="true">3.1.</strong> QEMU</a></li><li class="chapter-item expanded "><a href="infrastructure/edgerouter.html"><strong aria-hidden="true">3.2.</strong> EdgeRouter</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">Patrick's Lab Notebook</h1>

                    <div class="right-buttons">
                        
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                        <a href="https://github.com/patrickod/notebook" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h2><a class="header" href="#introduction" id="introduction">Introduction</a></h2>
<p>Welcome to my lab notebook. This book aims to be a slightly more tidied up transcription of the ideas and thoughts that I regularly capture in paper form. Its purposes are twofold, to serve as a richer, searchable medium for my work notes but also to invite discussion and participation from others. If we share an interest in anything I've written about then please do reach out - I'd love to hear all about your adventures!</p>
<p>The idea for this notebook repository was heavily inspired by the previous work of <a href="https://twitter.com/whitequark">whitequark</a> and <a href="https://twitter.com/bitshiftmask">James Munns</a>.</p>
<h2><a class="header" href="#projects" id="projects">projects</a></h2>
<p>this section captures notes on a selection of projects that I'm working on in some form or another. </p>
<h2><a class="header" href="#mcp2221" id="mcp2221">MCP2221</a></h2>
<p>The MCP2221 is a neat USB-to-UART/I2C serial converter that also features 4 GP pins which can be used for multiple functions (ADC, DAC, interrupt detection, clock output). It is intended to allow for easy communication with embedded devices over USB, either via the USB CDC interface for the UART, or via USB-HID events for the I2C and GPIO functions.</p>
<p>I'm specifically using the <a href="https://www.adafruit.com/product/4471">Adafruit MCP2221A breakout</a> which features both USB-C and a StemmaQT connectors. </p>
<p>There are already a number of open source libraries that support interfacing with the MCP2221 in languages such as Python, but so far there is none for Rust. I'm working on an implementation as a learning exercise to familiarize myself with the <code>embedded-hal</code> crate and its use of Traits.</p>
<h3><a class="header" href="#reference-material" id="reference-material">Reference material</a></h3>
<ul>
<li><a href="https://ww1.microchip.com/downloads/en/DeviceDoc/20005565C.pdf">Datasheet</a></li>
<li><a href="https://github.com/adafruit/Adafruit_Blinka/blob/master/src/adafruit_blinka/microcontroller/mcp2221/mcp2221.py">Adafruit Blinka library MCP2221 implementation</a></li>
</ul>
<h3><a class="header" href="#usb-hid" id="usb-hid">USB-HID</a></h3>
<p>With the exception of the UART which uses USB-CDC all of the functionality in the MCP2221 is accessed via the USB HID (Human Interface Device) procotol. USB HID works by sending 64 byte command and response packets between the USB host and peripheral devices.</p>
<p>Datasheet section <code>3.0</code> details the MCP2221 use of USB HID</p>
<h3><a class="header" href="#commands--bytes" id="commands--bytes">Commands &amp; bytes</a></h3>
<p><strong>misc commansd relating to steting device configuration values</strong></p>
<table><thead><tr><th>command</th><th>byte</th><th>description</th></tr></thead><tbody>
<tr><td><code>STATUS/SET_PARAMETERS</code></td><td><code>0x10</code></td><td>used both as the event which polls for status updates &amp; also sets certain I2C parameters</td></tr>
<tr><td><code>READ_FLASH_DATA</code></td><td><code>0xB0</code></td><td>reads data structures from flash memory (chip settings, GPIO settings, USB VID/PID, serial). takes variable which dictates which data structure should be serialized and returned</td></tr>
<tr><td><code>WRITE_FLASH_DATA</code></td><td><code>0xB1</code></td><td>writes the same configuration data structures into flash memory to adjust operation of the device. accepts variable which informs the device on how to interpret incoming bytes</td></tr>
<tr><td><code>SEND_FLASH_PASSWORD</code></td><td><code>0xB2</code></td><td>set an 8 byte password to prevent alteration of configuration (not implemented**</td></tr>
</tbody></table>
<p><strong>I2C transfer commands</strong></p>
<table><thead><tr><th>command</th><th>byte</th><th>description</th></tr></thead><tbody>
<tr><td><code>I2C_WRITE_DATA</code></td><td><code>0x90</code></td><td>initiate I2C transfers and in cases of transfers over 60 bytes to send the next 60 bytes repeatedly until exhausted.</td></tr>
<tr><td><code>I2C_WRITE_DATA_REPEATED_START</code></td><td><code>0x92</code></td><td>initiate I2C transfers using the repeated-start condition</td></tr>
<tr><td><code>I2C_WRITE_DATA_NO_STOP</code></td><td><code>0x94</code></td><td>initiate I2C transfers but withholds STOP condition on transfer end</td></tr>
<tr><td><code>I2C_READ_DATA</code></td><td><code>0x91</code></td><td>initiate/continue read I2C transfer (sends STOP)</td></tr>
<tr><td><code>I2C_READ_DATA_REPEATED_START</code></td><td><code>0x93</code></td><td>initiate read transfer with repeated START</td></tr>
<tr><td><code>I2C_READ_DATA</code></td><td><code>0x40</code></td><td>command which actually retrieves the I2C data for transfers started with the READ commands. Reads back responses in 60 byte chunks until complete</td></tr>
</tbody></table>
<p><strong>GPIO pin commands</strong></p>
<table><thead><tr><th>command</th><th>byte</th><th>description</th></tr></thead><tbody>
<tr><td><code>SET_GPIO_VALUES</code></td><td><code>0x50</code></td><td>Change the GPIO output values for pins configured to operate as GPIO outputs</td></tr>
<tr><td><code>GET_GPIO_VALUES</code></td><td>`0x51**</td><td>Read back direction and pin value information for all pins operating as GPIO</td></tr>
</tbody></table>
<p><strong>SRAM settings</strong>*</p>
<table><thead><tr><th>command</th><th>byte</th><th>description</th></tr></thead><tbody>
<tr><td><code>SET_SRAM_SETTINGS</code></td><td><code>0x60</code></td><td>alters run-time chip settings which are not persisted to flash and which are reset upon power-down</td></tr>
<tr><td><code>GET_SRAM_SETTINGS</code></td><td>`0x61**</td><td>read back ephemeral run-time chip settings</td></tr>
</tbody></table>
<p><strong>Misc</strong>*
| command      | byte   | description                                                                                                |
|--------------|--------|------------------------------------------------------------------------------------------------------------|
| <code>CHIP_RESET</code> | <code>0x70</code> | forces a reset of the MCP2221. usually performed after updaing Flash config values to put them into effect |
|              |        |                                                                                                            |</p>
<h2><a class="header" href="#infrastructure" id="infrastructure">Infrastructure</a></h2>
<p>This section is a pseudo personal runbook for the administrative tasks involved in my personal infrastructure. It is mainly a collection of short command snippets and configuration files which I use repeatedly in different setups.</p>
<h2><a class="header" href="#qemu--libvirtd" id="qemu--libvirtd">QEMU + libvirtd</a></h2>
<h4><a class="header" href="#creating-sparse-img" id="creating-sparse-img">creating sparse img</a></h4>
<p>new sparse &quot;qcow2&quot; type image of size 128GB</p>
<pre><code class="language-bash">qemu-img create -f qcow2 guest.img 128G
</code></pre>
<h4><a class="header" href="#create-sparse-cow-img-based-on-snapshot" id="create-sparse-cow-img-based-on-snapshot">create sparse CoW img based on snapshot</a></h4>
<pre><code class="language-bash">qemu-img create -f qcow2 -b snapshot.img new-guest.img
</code></pre>
<h2><a class="header" href="#edgerouter-os-upgrade" id="edgerouter-os-upgrade">EdgeRouter OS upgrade</a></h2>
<h4><a class="header" href="#get-current-version" id="get-current-version">get current version</a></h4>
<pre><code class="language-bash">$ show version
Version:      v2.0.8-hotfix.1
Build ID:     5278088
Build on:     03/05/20 16:40
Copyright:    2012-2019 Ubiquiti Networks, Inc.
HW model:     EdgeRouter Lite 3-Port
HW S/N:       24A43C05210C
Uptime:       19:13:59 up 90 days, 16:27,  1 user,  load average: 1.18, 0.41, 0.13
</code></pre>
<pre><code class="language-bash">$ show system image
The system currently has the following image(s) installed:

v2.0.9.5346345.201028.1646     (default boot) 
v2.0.8-hotfix.1.5278088.200305.1640 (running image) 

A reboot is needed to boot default image
</code></pre>
<h4><a class="header" href="#install-os-image" id="install-os-image">install OS image</a></h4>
<pre><code class="language-bash">add system image https://dl.ui.com/firmwares/edgemax/v2.0.9/ER-e100.v2.0.9.5346345.tar
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        

                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                

                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        
        
        <script type="text/javascript">
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>
        
        

    </body>
</html>
